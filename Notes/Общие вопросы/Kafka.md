## 1. Введение: брокер сообщений

**Брокер сообщений** — это программа, которая принимает и сохраняет данные, передаваемые между приложениями.

Основные свойства:

- Данные обычно передаются в текстовом формате.
    
- Получатели опрашивают брокер на наличие новых данных.
    

Примеры брокеров: **RabbitMQ**, **Redis**, **Kafka**.

### Преимущества брокера сообщений

- **Асинхронность**: отправитель не ждёт ответа от получателя, он просто отправляет сообщение брокеру и переходит дальше.
    
- **Гарантия доставки**: данные сохраняются в брокере, даже если консьюмер временно недоступен, так как сообщения сохраняются в брокере.
    
- **Устойчивость к сбоям**: при отключении потребителя брокер хранит данные и позволяет обработать их позже.
    
- **Масштабируемость**: новые потребители могут подключаться к брокеру без изменений в коде продюсера.

---

## 2. Продюсер и Консьюмер

- **Продюсер (Producer)** — программа, отправляющая данные в брокер сообщений.
    
- **Консьюмер (Consumer)** — программа, получающая данные из брокера сообщений.

---

## 3. Топики

**Топик (Topic)** — это логический канал в Kafka для сообщений определённого типа.

### Зачем нужны топики

- Если все сообщения попадут в один поток, потребителям будет трудно отличать их друг от друга.
    
- Топики решают эту проблему, разделяя данные на категории:
    
    - посты
        
    - комментарии
        
    - лайки
        
    - уведомления
        

Аналогия: **телеканалы** — один для новостей, другой для спорта.

### Взаимодействие

- Микросервис постов пишет в топик `posts`.
    
- Микросервис уведомлений подписывается на топик `posts`.
    
- Один сервис может быть **и продюсером, и консьюмером** в разных топиках.

---

## 4. Гарантии доставки

Kafka предоставляет разные уровни гарантии доставки:

1. **At most once** («максимум один раз»)
    
    - Сообщение может потеряться.
        
    - Быстро, подходит для некритичных данных (например, аналитика, логи).
        
2. **At least once** («минимум один раз»)
    
    - Сообщение гарантированно дойдёт, но может прийти **дважды**.
        
    - Подходит для большинства сценариев.
        
3. **Exactly once** («ровно один раз»)
    
    - Сообщение дойдёт гарантированно и не будет дубликатов.
        
    - Достигается сложными механизмами (идемпотентность, транзакции).
        

### Проблема дубликатов

- При доставке «минимум один раз» возможны повторы.
    
- Решение: **идемпотентные консьюмеры**, которые обрабатывают повтор так, будто он один.
    
- Пример: проверка в БД перед записью, фильтрация по уникальному ID.
