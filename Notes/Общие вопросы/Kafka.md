## 1. Введение: брокер сообщений

**Брокер сообщений** — это программа, которая принимает и сохраняет данные, передаваемые между приложениями.

Основные свойства:

- Данные обычно передаются в текстовом формате.
    
- Получатели опрашивают брокер на наличие новых данных.
    

Примеры брокеров: **RabbitMQ**, **Redis**, **Kafka**.

### Преимущества брокера сообщений

- **Асинхронность**: отправитель не ждёт ответа от получателя, он просто отправляет сообщение брокеру и переходит дальше.
    
- **Гарантия доставки**: данные сохраняются в брокере, даже если консьюмер временно недоступен, так как сообщения сохраняются в брокере.
    
- **Устойчивость к сбоям**: при отключении потребителя брокер хранит данные и позволяет обработать их позже.
    
- **Масштабируемость**: новые потребители могут подключаться к брокеру без изменений в коде продюсера.

---

## 2. Продюсер и Консьюмер

- **Продюсер (Producer)** — программа, отправляющая данные в брокер сообщений.
    
- **Консьюмер (Consumer)** — программа, получающая данные из брокера сообщений.

---

## 3. Топики

**Топик (Topic)** — это логический канал в Kafka для сообщений определённого типа.

### Зачем нужны топики

- Если все сообщения попадут в один поток, потребителям будет трудно отличать их друг от друга.
    
- Топики решают эту проблему, разделяя данные на категории:
    
    - посты
        
    - комментарии
        
    - лайки
        
    - уведомления
        

Аналогия: **телеканалы** — один для новостей, другой для спорта.

### Взаимодействие

- Микросервис постов пишет в топик `posts`.
    
- Микросервис уведомлений подписывается на топик `posts`.
    
- Один сервис может быть **и продюсером, и консьюмером** в разных топиках.

---

## 4. Гарантии доставки

Kafka предоставляет разные уровни гарантии доставки:

1. **At most once** («максимум один раз»)
    
    - Сообщение может потеряться.
        
    - Быстро, подходит для некритичных данных (например, аналитика, логи).
        
2. **At least once** («минимум один раз») - стоит по умолчанию
    
    - Сообщение гарантированно дойдёт, но может прийти **дважды**.
        
    - Подходит для большинства сценариев.
        
3. **Exactly once** («ровно один раз»)
    
    - Сообщение дойдёт гарантированно и не будет дубликатов.
        
    - Достигается сложными механизмами (идемпотентность, транзакции).
        

### Проблема дубликатов

- При доставке «минимум один раз» возможны повторы.
    
- Решение: **идемпотентные консьюмеры**, которые обрабатывают повтор так, будто он один.
    
- Пример: проверка в БД перед записью, фильтрация по уникальному ID.


**Идемпотентные консьюмеры** реализуются посредством сохранения сообщений с ID в бд, когда приходит новое сообщение, происходит проверка в бд - не было ли сообщения с таким же ID

---

## 5. Партишины (Partitions)

**Партишин** — это часть топика, хранящая подмножество сообщений.

### Зачем нужны

- Увеличивают пропускную способность.
    
- Позволяют обрабатывать данные параллельно.
    
- Разные консьюмеры могут читать разные партишины.
    

### Особенности

- Каждое сообщение попадает только в **один партишин**.
    
- Сообщения в рамках одного партишина упорядочены.
    
- Распределение сообщений идёт равномерно (round-robin) или по **ключу**.
    

### Пример

Топик `posts` разбит на 5 партишинов:

- Сообщение о посте попадает в один из 5 партишинов.
    
- Консьюмер читает из всех партишинов.
    

### Порядок сообщений

- Между разными партишинами порядок **не гарантируется**.
    
- Внутри одного партишина — порядок всегда сохраняется.
    
- Чтобы гарантировать порядок для связанных данных → используем **ключ** (например, `user_id`).

---

## 6. Репликация и отказоустойчивость

- Kafka запускается как **кластер** из нескольких серверов (брокеров).
    
- Каждый партишин может иметь **несколько копий (реплик)**.
    
- Основной партишин называется **Leader**, остальные — **Followers**.
    

### Преимущества

- При сбое одного брокера данные не теряются.
    
- Консьюмеры читают данные с **лидера**, фолловеры нужны для резервного копирования.
    
- Подтверждение доставки даётся только после записи на все реплики.
    

### Практика

- Минимум **3 брокера** в кластере для надёжности.
    
- Чем больше реплик → тем выше надёжность, но ниже производительность.
    

---

## 7. Масштабирование

- Добавление новых **партишинов** увеличивает пропускную способность.
    
- Распределение партишинов по брокерам позволяет эффективно использовать ресурсы.
    
- При росте нагрузки можно добавлять новые консьюмеры (в рамках consumer group).
    

---

## 8. Применение Kafka

- Event-driven архитектуры.
    
- Реалтай аналитика (метрики, логи, мониторинг).
    
- Интеграция микросервисов.
    
- ETL-процессы (сбор, преобразование и загрузка данных).
    

Пример:

- Микросервис постов пишет события в Kafka.
    
- Микросервис уведомлений читает эти события и отправляет пользователям уведомления.
    
- При увеличении нагрузки — просто добавляем новые инстансы сервисов.
    

---

## Итоги

- Kafka — это не просто брокер, а **распределённая система для обработки событий в реальном времени**.
    
- Ключевые механизмы: **продюсер, консьюмер, топик, партишин, репликация**.
    
- Гарантии доставки позволяют балансировать между скоростью и надёжностью.
    
- Масштабируемость достигается за счёт **кластеризации и партишинов**.