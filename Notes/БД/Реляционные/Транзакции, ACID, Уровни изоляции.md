## Транзакция

**Транзакция** - это последовательность действий с базой данных, в которой либо все действия выполняются успешно, либо не выполняется ни одно из них.

Транзакция переводит базу данных из одного логически согласованное состояния в другое логически согласованное Результатом транзакции может быть либо совершение изменений (commit), либо откат к исходному состоянию (rollback)

### ACID

Чтобы ваша последовательность действий называлась транзакцией, нужно соблюдение этих свойств ACID:

- **Atomicity** - атомарность: транзакция неделима - либо выполняются все действия, либо ни одного
    
- **Consistency** - согласованность: транзакция переводит одно согласованное состояние базы данных в другое согласованное состояние базы данных без соблюдения поддержки согласованности в промежуточных точках
    
- **Isolation** - изоляция: если запущено несколько конкурирующих транзакций, то любой обновление, выполненное одной транзакцией, скрыто от других до ее завершения
    
- **Durability** - долговечность: когда транзакция завершена, ее результаты сохраняются, даже если в следующий момент произойдет сбой


## Уровни изоляции

### Аномалии

1. Проблема грязного чтения 
	![[Pasted image 20251029154437.png]]

> **Грязное чтение (Dirty read)** - это когда данные которые я прочитал, кто-то может откатить еще до того, как я завершу свою транзакцию

2. Проблема неповторяющегося чтения 
	![[Pasted image 20251029154801.png]]

> **Неповторяющееся чтение (Non-repeatable read)** - это когда данные, которые я прочитал, кто-то может изменить до того, как я завершу свою транзакцию

3. Проблема фантомного чтения 
	![[Pasted image 20251029155329.png]]

> **Фантомное чтение (Fantom read)** - это когда ряд данных, которые я прочитал, кто-то может изменить до того, как я завершу свою транзакцию

Отличие от неповторяющегося чтения в том, что вносят или удаляют строки, а не меняют их содержимое 

### Read Uncommited

**Read Uncommited** - это самый слабый уровень изоляции, когда транзакция может видеть результаты других транзакций даже если они еще не закоммичены 

Допускает:
- Грязное чтение
- Неповторяющееся чтение
- Фантомное чтение
### Read Commited

**Read Commited** - на этом уровне транзакция может читать только те изменения в других параллельных транзакциях, которые уже были закоммичены

Предотвращает:
- Грязное чтение

Допускает:
- Неповторяющееся чтение
- Фантомное чтение

_По умолчанию используется в **PostgreSQL**_

### Repeatable Read

**Repeatable Read** - этот уровень означает, что пока транзакция не завершиться никто параллельно не может изменять или удалять строки, которые транзакция уже прочитала

Предотвращает:
- Грязное чтение
- Неповторяющееся чтение

Допускает:
- Фантомное чтение

_По умолчанию используется в **MySQL**_

### Serializable

**Serializable** - самый жесткий, но самый тяжелый для БД и медленный для обработки запросов уровень
Он блокирует любые действия, пока запущена транзакция - получается транзакции идут строго одна за другой и максимально изолированы друг от друга.
Это достигается с помощью блокировки всей таблицы от любых взаимодействий с ней, но некоторые СУБД делают менее радикально - блокируют только те строки, которые задействует текущая транзакция

Предотвращает:
- Грязное чтение
- Неповторяющееся чтение
- Фантомное чтение

Но сильно страдает производительность, из-за того что транзакции не могут работаться параллельно