## Транзакция

**Транзакция** - это последовательность действий с базой данных, в которой либо все действия выполняются успешно, либо не выполняется ни одно из них.

Транзакция переводит базу данных из одного логически согласованное состояния в другое логически согласованное Результатом транзакции может быть либо совершение изменений (commit), либо откат к исходному состоянию (rollback)

### ACID

Чтобы ваша последовательность действий называлась транзакцией, нужно соблюдение этих свойств ACID:

- **Atomicity** - атомарность: транзакция неделима - либо выполняются все действия, либо ни одного
    
- **Consistency** - согласованность: транзакция переводит одно согласованное состояние базы данных в другое согласованное состояние базы данных без соблюдения поддержки согласованности в промежуточных точках
    
- **Isolation** - изоляция: если запущено несколько конкурирующих транзакций, то любой обновление, выполненное одной транзакцией, скрыто от других до ее завершения
    
- **Durability** - долговечность: когда транзакция завершена, ее результаты сохраняются, даже если в следующий момент произойдет сбой


## Уровни изоляции

Ситуация: пользователи A и C захотели перевести пользователю B по 100 шекелей

|Пользователь|Остаток на счете|
|---|---|
|A|100|
|B|200|
|С|100|
В итоге может произойти такая последовательность действий:

- Пользователю A присвоили 0 шекелей
- Пользователю С присвоили 0 шекелей
- Пользователю B присвоили 300 шекелей (200 изначальных + 100 от A)
- Пользователю B присвоили 300 шекелей (200 изначальных + 100 от C)

В итоге произошла гонка обновлений (race-condition) - вторая транзакция слишком рано прочитала баланс у пользователя B и изменила его баланс на 300, когда он и так уже был 300 в ходе работы первой транзакции. Это проблема получила название **проблемы потерянного обновления**

Решение - 1 уровень изоляции **“_Незавершенное чтение_”**: требуем, что бы только одна транзакция могла записывать данные

Другой кейс: C решил перевести 100 шекелей к A, а A, получив от C деньги, захотел перевести 200 шекелей B

В итоге первая транзакция может где-то после начисления денег A откатиться, но вторая транзакция выполнилась до отката первой - у A уже нулевой баланс, поэтому у A в ходе отката получится -100

Возникает _проблема грязного чтения_, ее решение - 2 уровень изоляции **“_Завершенное чтение_”**: если какая-то транзакция изменяет данные, то никакая другая не может их читать


